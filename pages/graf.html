<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sledov√°n√≠ c√≠le v eKorun√°ch - Inteligentn√≠ tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 25px 40px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        text-align: center;
        color: #2c3e50;
      }
      h2 {
        margin-top: 40px;
        border-top: 1px solid #e0e0e0;
        padding-top: 30px;
      }
      .chart-container {
        position: relative;
        height: 50vh;
        width: 100%;
        margin-top: 30px;
      }
      .table-container {
        margin-top: 20px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
      }
      thead th {
        background-color: #e9ecef;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      th[title] {
        cursor: help;
      }
      tr.is-today {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
      }
      tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      tr:hover {
        background-color: #e2e6ea;
      }
      input[type='number'] {
        width: 90px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        text-align: right;
        font-size: 14px;
      }
      .cumulative-cell,
      .plan-cell,
      .adjusted-plan-cell {
        text-align: right;
      }
      .cumulative-cell {
        font-weight: bold;
      }
      .adjusted-plan-cell.is-behind {
        font-weight: bold;
        color: #d9534f;
        background-color: #f8d7da;
      }
      .adjusted-plan-cell.is-ahead {
        font-style: italic;
        color: #28a745;
        background-color: #d4edda;
      }
      .instructions {
        background-color: #e7f3fe;
        border-left: 6px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }
      .controls {
        text-align: right;
        margin-top: 15px;
      }
      .download-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin-left: 10px;
      }
      .import-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin-left: 10px;
      }
      .file-input {
        display: none;
      }
      .clear-button {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin-left: 10px;
      }
      .tutorial {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 25px;
        margin-top: 40px;
      }
      .tutorial h3 {
        color: #2c3e50;
        margin-top: 0;
        border-bottom: 2px solid #007bff;
        padding-bottom: 8px;
      }
      .tutorial-step {
        margin: 15px 0;
        padding: 10px;
        background-color: white;
        border-left: 4px solid #007bff;
        border-radius: 4px;
      }
      .tutorial-step strong {
        color: #007bff;
      }
      .stats {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
      }
      .stat-item {
        display: inline-block;
        margin: 0 15px;
        font-size: 14px;
      }
      .stat-value {
        font-weight: bold;
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sledov√°n√≠ c√≠le v eKorun√°ch - Inteligentn√≠ tracker</h1>
      <p class="instructions">
        <strong>V√≠tejte u va≈°eho osobn√≠ho pr≈Øvodce k √∫spƒõchu!</strong> üí™ Tento n√°stroj v√°m pom≈Ø≈æe dos√°hnout c√≠le 27 842 eKorun mezi 11.
        ƒçervnem a 30. z√°≈ô√≠ 2025. Staƒç√≠ ka≈æd√Ω pracovn√≠ den zapsat, kolik eKorun jste z√≠skali, a n√°stroj v√°m uk√°≈æe, zda jste na spr√°vn√© cestƒõ.
        Pokud se dostanete do skluzu, automaticky v√°m navrhne novou "z√°chrannou strategii" - p≈ôesnƒõ to, co pot≈ôebujete dƒõlat, abyste c√≠l
        st√°le stihli. <strong>M≈Ø≈æete na to!</strong> üéØ
      </p>

      <div class="stats" id="statsContainer">
        <div class="stat-item">
          <span>Celkov√© dny (bez v√≠kend≈Ø): </span>
          <span class="stat-value" id="totalWorkDays">-</span>
        </div>
        <div class="stat-item">
          <span>Zb√Ωvaj√≠c√≠ dny: </span>
          <span class="stat-value" id="remainingDays">-</span>
        </div>
        <div class="stat-item">
          <span>P≈Øvodn√≠ denn√≠ c√≠l: </span>
          <span class="stat-value" id="originalDailyGoal">-</span>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="progressChart"></canvas>
      </div>
      <h2>Z√°znamy a data (pouze pracovn√≠ dny)</h2>
      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Z√≠skan√© eKƒç za den</th>
              <th>eKƒç celkem (kumulativnƒõ)</th>
              <th>P≈Øvodn√≠ pl√°n / Kritick√° mez</th>
              <th title="Aktivuje se p≈ôi skluzu - ukazuje nov√Ω denn√≠ c√≠l pro doh√°nƒõn√≠">Upraven√Ω pl√°n (Z√°chrann√° strategie)</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
      <div class="controls">
        <input type="file" id="csvFileInput" class="file-input" accept=".csv" />
        <button id="importCsvButton" class="import-button">Nahr√°t CSV</button>
        <button id="downloadExcelButton" class="download-button">St√°hnout Excel (XLSX)</button>
        <button id="downloadCsvButton" class="download-button">St√°hnout CSV</button>
        <button id="clearDataButton" class="clear-button">Vymazat ulo≈æen√° data</button>
      </div>

      <!-- Tutorial Section -->
      <div class="tutorial">
        <h3>üìñ Jak pou≈æ√≠vat tento n√°stroj</h3>

        <div class="tutorial-step">
          <strong>1. Denn√≠ zad√°v√°n√≠ dat:</strong><br />
          Ka≈æd√Ω pracovn√≠ den (pondƒõl√≠-p√°tek) zapi≈°te do sloupce "Z√≠skan√© eKƒç za den", kolik eKorun jste ten den z√≠skali. V√≠kendy se
          nepoƒç√≠taj√≠ a nejsou v tabulce.
        </div>

        <div class="tutorial-step">
          <strong>2. Sledov√°n√≠ pokroku:</strong><br />
          Sledujte sloupec "eKƒç celkem" - ukazuje v√°≈° celkov√Ω pokrok. Porovnejte ho s "P≈Øvodn√≠m pl√°nem" abyste vidƒõli, zda jste na spr√°vn√©
          cestƒõ.
        </div>

        <div class="tutorial-step">
          <strong>3. Kritick√° mez:</strong><br />
          ƒåerven√© ƒç√≠slo pod p≈Øvodn√≠m pl√°nem je kritick√° mez (80% pl√°nu). Pokud klesne va≈°e realita pod tuto mez, je ƒças zaƒç√≠t v√≠ce zab√≠rat!
        </div>

        <div class="tutorial-step">
          <strong>4. Inteligentn√≠ "Z√°chrann√° strategie":</strong><br />
          Nejchyt≈ôej≈°√≠ ƒç√°st n√°stroje! Pokud se dostanete za p≈Øvodn√≠ pl√°n, sloupec "Upraven√Ω pl√°n" se automaticky aktivuje a uk√°≈æe v√°m:
          <ul style="margin-top: 8px">
            <li><strong>Nov√Ω denn√≠ c√≠l</strong> - kolik pot≈ôebujete z√≠sk√°vat dennƒõ od dne≈°ka</li>
            <li><strong>Kumulativn√≠ c√≠le</strong> - kde byste mƒõli b√Ωt ka≈æd√Ω dal≈°√≠ den</li>
            <li><strong>Re√°ln√Ω pl√°n n√°vratu</strong> - p≈ôesnƒõ co dƒõlat, abyste c√≠l stihli</li>
          </ul>
        </div>

        <div class="tutorial-step">
          <strong>5. Vizu√°ln√≠ sledov√°n√≠:</strong><br />
          Graf naho≈ôe ukazuje t≈ôi linie:
          <ul style="margin-top: 8px">
            <li><strong>Modr√° (REALITA)</strong> - v√°≈° skuteƒçn√Ω pokrok</li>
            <li><strong>≈†ed√° p≈ôeru≈°ovan√° (PL√ÅN)</strong> - p≈Øvodn√≠ ide√°ln√≠ trajektorie</li>
            <li><strong>ƒåerven√° (KRITICK√Å MEZ)</strong> - varovn√° hranice</li>
          </ul>
        </div>

        <div class="tutorial-step">
          <strong>6. Import a Export dat:</strong><br />
          <ul style="margin-top: 8px">
            <li><strong>Nahr√°t CSV:</strong> Importujte data z CSV souboru (form√°t: Datum, Den, Z√≠skan√© eKƒç, ...)</li>
            <li><strong>St√°hnout CSV:</strong> Z√°kladn√≠ export pro dal≈°√≠ zpracov√°n√≠</li>
            <li><strong>St√°hnout Excel:</strong> Pokroƒçil√Ω export s dvƒõma listy - "Data" s tabulkou a "Graf" s daty pro vytvo≈ôen√≠ grafu</li>
          </ul>
        </div>

        <div class="tutorial-step">
          <strong>7. Automatick√© ukl√°d√°n√≠:</strong><br />
          N√°stroj ukl√°d√° data automaticky do va≈°eho prohl√≠≈æeƒçe. M≈Ø≈æete str√°nku zav≈ô√≠t a vr√°tit se pozdƒõji - data z≈Østanou zachov√°na!
        </div>

        <div class="tutorial-step">
          <strong>üí° Tip:</strong><br />
          Pro z√°lohu doporuƒçujeme pravidelnƒõ exportovat data do Excel souboru. P≈ôi p≈ôechodu na nov√Ω poƒç√≠taƒç m≈Ø≈æete data znovu importovat
          pomoc√≠ CSV.
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // --- NASTAVEN√ç ---
        const startDate = new Date('2025-06-11T00:00:00')
        const endDate = new Date('2025-09-30T00:00:00')
        const totalGoal = 27842
        const LOCAL_STORAGE_KEY = 'eKorunyProgressData_v7_workdays'

        let chartData = []

        // --- POMOCN√â FUNKCE ---
        function formatCurrency(value) {
          return value.toFixed(2).replace('.', ',') + ' Kƒç'
        }

        function isSameDay(date1, date2) {
          return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate()
        }

        function isWeekend(date) {
          const day = date.getDay()
          return day === 0 || day === 6 // Nedƒõle nebo sobota
        }

        function isWorkDay(date) {
          return !isWeekend(date)
        }

        // --- GENEROV√ÅN√ç DAT (BEZ V√çKEND≈Æ) ---
        function generateInitialData() {
          let data = []
          let currentDate = new Date(startDate)

          // Nejd≈ô√≠ve spoƒç√≠t√°me v≈°echny pracovn√≠ dny
          let workDays = []
          while (currentDate <= endDate) {
            if (isWorkDay(currentDate)) {
              workDays.push(new Date(currentDate))
            }
            currentDate.setDate(currentDate.getDate() + 1)
          }

          const totalWorkDays = workDays.length
          const dailyGoalIncrement = totalGoal / (totalWorkDays - 1) // Prvn√≠ den zaƒç√≠n√° na 0

          // Vytvo≈ô√≠me data pro ka≈æd√Ω pracovn√≠ den
          workDays.forEach((date, index) => {
            const cumulativePlan = index === 0 ? 0 : dailyGoalIncrement * index
            const critical = cumulativePlan * 0.8

            data.push({
              date: new Date(date),
              plan: index === workDays.length - 1 ? totalGoal : cumulativePlan, // Posledn√≠ den = p≈ôesnƒõ c√≠l
              critical: index === workDays.length - 1 ? totalGoal * 0.8 : critical,
              dailyInput: 0,
              reality: 0,
              workDayIndex: index,
            })
          })

          // Aktualizujeme statistiky
          document.getElementById('totalWorkDays').textContent = totalWorkDays
          document.getElementById('originalDailyGoal').textContent = formatCurrency(dailyGoalIncrement)

          return data
        }

        function saveDataToLocalStorage() {
          const dataToSave = chartData.map(d => ({
            dateStr: d.date.toISOString(),
            dailyInput: d.dailyInput,
          }))
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave))
        }

        function loadDataFromLocalStorage() {
          const savedJSON = localStorage.getItem(LOCAL_STORAGE_KEY)
          if (savedJSON) {
            try {
              const savedData = JSON.parse(savedJSON)
              if (Array.isArray(savedData)) {
                savedData.forEach(saved => {
                  const matchingDay = chartData.find(d => d.date.toISOString() === saved.dateStr)
                  if (matchingDay) {
                    matchingDay.dailyInput = Number(saved.dailyInput) || 0
                  }
                })
              }
            } catch (e) {
              console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', e)
            }
          }
        }

        // --- HLAVN√ç AKTUALIZAƒåN√ç FUNKCE ---
        function updateAll() {
          const today = new Date()
          today.setHours(0, 0, 0, 0) // Normalizace ƒçasu

          // KROK 1: Vypoƒç√≠tat kumulativn√≠ realitu
          let cumulativeReality = 0
          chartData.forEach(day => {
            cumulativeReality += day.dailyInput
            day.reality = cumulativeReality
          })

          // KROK 2: Naj√≠t nejvhodnƒõj≈°√≠ den pro porovn√°n√≠
          let adjustmentNeeded = false
          let newDailyTarget = 0
          let currentReality = 0
          let currentPlan = 0
          let comparisonDate = null

          // Najdeme nejpozdƒõji zadan√Ω den s daty, nebo dne≈°n√≠ den
          let lastDataIndex = -1
          for (let i = chartData.length - 1; i >= 0; i--) {
            if (chartData[i].dailyInput > 0 || isSameDay(chartData[i].date, today)) {
              lastDataIndex = i
              break
            }
          }

          // Pokud nem√°me ≈æ√°dn√° data, zkus√≠me alespo≈à naj√≠t dne≈°n√≠ den
          if (lastDataIndex === -1) {
            lastDataIndex = chartData.findIndex(d => isSameDay(d.date, today))
          }

          // Pokud st√°le nem√°me index, pou≈æijeme posledn√≠ pracovn√≠ den p≈ôed dnes
          if (lastDataIndex === -1) {
            for (let i = chartData.length - 1; i >= 0; i--) {
              if (chartData[i].date <= today) {
                lastDataIndex = i
                break
              }
            }
          }

          if (lastDataIndex >= 0) {
            currentReality = chartData[lastDataIndex].reality
            currentPlan = chartData[lastDataIndex].plan
            comparisonDate = chartData[lastDataIndex].date

            console.log('Porovn√°v√°m:', {
              datum: comparisonDate.toLocaleDateString('cs-CZ'),
              realita: currentReality,
              plan: currentPlan,
              pozadu: currentReality < currentPlan,
            })

            // Zkontrolujeme, jestli jsme pozadu
            if (currentReality < currentPlan && currentPlan > 0) {
              adjustmentNeeded = true

              // Spoƒç√≠t√°me zb√Ωvaj√≠c√≠ pracovn√≠ dny od dne≈°ka
              const remainingWorkDays = chartData.filter(d => d.date >= today).length

              if (remainingWorkDays > 0) {
                const remainingGoal = totalGoal - currentReality
                newDailyTarget = remainingGoal / remainingWorkDays

                console.log('√öprava pl√°nu:', {
                  zb√Ωvac√≠C√≠l: remainingGoal,
                  zb√Ωvac√≠Dny: remainingWorkDays,
                  nov√ΩDenn√≠C√≠l: newDailyTarget,
                })
              }
            }
          }

          // Aktualizujeme zb√Ωvaj√≠c√≠ dny
          const remainingWorkDays = chartData.filter(d => d.date >= today).length
          document.getElementById('remainingDays').textContent = remainingWorkDays

          // KROK 3: Aktualizovat tabulku
          chartData.forEach((day, index) => {
            // Aktualizovat kumulativn√≠ hodnotu
            document.getElementById(`cumulative-${index}`).textContent = formatCurrency(day.reality)

            // Aktualizovat upraven√Ω pl√°n
            const adjustedCell = document.getElementById(`adjusted-plan-${index}`)
            const isToday = isSameDay(day.date, today)
            const isFutureDay = day.date >= today

            if (!isFutureDay && !isToday) {
              // Minul√© dny
              adjustedCell.innerHTML = '‚Äì'
              adjustedCell.className = 'adjusted-plan-cell'
            } else if (adjustmentNeeded && newDailyTarget > 0) {
              // Pot≈ôebujeme √∫pravu - uk√°≈æeme nov√Ω pl√°n
              const daysFromComparisonDate = Math.max(0, chartData.filter(d => d.date >= comparisonDate && d.date <= day.date).length - 1)
              const adjustedTarget = currentReality + (daysFromComparisonDate + 1) * newDailyTarget

              adjustedCell.innerHTML = `<strong>${formatCurrency(adjustedTarget)}</strong><br><small>Nov√Ω c√≠l: +${formatCurrency(
                newDailyTarget
              )}/den</small>`
              adjustedCell.className = 'adjusted-plan-cell is-behind'
            } else if (isFutureDay || isToday) {
              // Jsme nap≈ôed nebo v po≈ô√°dku
              adjustedCell.innerHTML = '<strong>‚úì Jste v po≈ô√°dku!</strong>'
              adjustedCell.className = 'adjusted-plan-cell is-ahead'
            } else {
              adjustedCell.innerHTML = '‚Äì'
              adjustedCell.className = 'adjusted-plan-cell'
            }
          })

          // KROK 4: Aktualizovat graf
          progressChart.data.datasets[0].data = chartData.map(d => d.reality)
          progressChart.update()
        }

        // --- INICIALIZACE ---
        chartData = generateInitialData()

        const tableBody = document.getElementById('dataBody')
        const today = new Date()

        chartData.forEach((day, index) => {
          const row = tableBody.insertRow()
          const isToday = isSameDay(day.date, today)

          if (isToday) {
            row.className = 'is-today'
          }

          const dayName = day.date.toLocaleDateString('cs-CZ', { weekday: 'short' })
          const dateStr = day.date.toLocaleDateString('cs-CZ', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
          })

          row.innerHTML = `
            <td><strong>${dayName}</strong><br>${dateStr}</td>
            <td><input type="number" min="0" step="any" data-index="${index}" placeholder="0"></td>
            <td class="cumulative-cell" id="cumulative-${index}">0,00 Kƒç</td>
            <td class="plan-cell">
              ${formatCurrency(day.plan)}<br>
              <span style="color:#dc3545; font-size: 0.9em;">(kritick√°: ${formatCurrency(day.critical)})</span>
            </td>
            <td class="adjusted-plan-cell" id="adjusted-plan-${index}">‚Äì</td>
          `
        })

        // Naƒçten√≠ ulo≈æen√Ωch dat
        loadDataFromLocalStorage()

        // Naplnƒõn√≠ input≈Ø ulo≈æen√Ωmi daty
        chartData.forEach((day, index) => {
          const input = document.querySelector(`input[data-index='${index}']`)
          if (day.dailyInput > 0) {
            input.value = day.dailyInput
          }
        })

        // Vytvo≈ôen√≠ grafu
        const ctx = document.getElementById('progressChart').getContext('2d')
        const progressChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartData.map(d => {
              const day = d.date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' })
              const weekday = d.date.toLocaleDateString('cs-CZ', { weekday: 'short' })
              return `${day} (${weekday})`
            }),
            datasets: [
              {
                label: 'REALITA',
                data: chartData.map(d => d.reality),
                borderColor: '#007bff',
                backgroundColor: '#007bff20',
                borderWidth: 3,
                fill: false,
                tension: 0.1,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4,
              },
              {
                label: 'PL√ÅN',
                data: chartData.map(d => d.plan),
                borderColor: '#6c757d',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 2,
                fill: false,
              },
              {
                label: 'KRITICK√Å MEZ',
                data: chartData.map(d => d.critical),
                borderColor: '#dc3545',
                borderWidth: 2,
                pointRadius: 1,
                fill: false,
                borderDash: [2, 2],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => `${value.toLocaleString('cs-CZ')} Kƒç`,
                },
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                },
              },
            },
            plugins: {
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`,
                  title: context => {
                    const index = context[0].dataIndex
                    const date = chartData[index].date
                    return date.toLocaleDateString('cs-CZ', {
                      weekday: 'long',
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })
                  },
                },
              },
              legend: {
                position: 'top',
              },
            },
          },
        })

        // --- DOWNLOAD FUNKCE ---
        function downloadCSV() {
          const headers = [
            'Datum',
            'Den v t√Ωdnu',
            'Z√≠skan√© eKƒç za den',
            'eKƒç celkem (kumulativnƒõ)',
            'P≈Øvodn√≠ pl√°n',
            'Kritick√° mez',
            'Upraven√Ω pl√°n',
          ]

          let csvContent = headers.join(',') + '\n'

          chartData.forEach((day, index) => {
            const adjustedCell = document.getElementById(`adjusted-plan-${index}`)
            const adjustedPlanText = adjustedCell.textContent.replace(/\n/g, ' ').replace(/,/g, ';')

            const row = [
              day.date.toLocaleDateString('cs-CZ'),
              day.date.toLocaleDateString('cs-CZ', { weekday: 'long' }),
              day.dailyInput || 0,
              day.reality.toFixed(2),
              day.plan.toFixed(2),
              day.critical.toFixed(2),
              adjustedPlanText,
            ]
            csvContent += row.join(',') + '\n'
          })

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
          const link = document.createElement('a')
          const url = URL.createObjectURL(blob)
          link.setAttribute('href', url)
          link.setAttribute('download', `eKoruny_tracker_${new Date().toISOString().split('T')[0]}.csv`)
          link.style.visibility = 'hidden'
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
        }

        function downloadExcel() {
          // P≈ôiprav√≠me data pro Excel
          const wsData = [
            ['Sledov√°n√≠ c√≠le v eKorun√°ch - Export dat'],
            ['Datum exportu:', new Date().toLocaleDateString('cs-CZ')],
            ['Celkov√Ω c√≠l:', totalGoal + ' Kƒç'],
            ['Obdob√≠:', startDate.toLocaleDateString('cs-CZ') + ' - ' + endDate.toLocaleDateString('cs-CZ')],
            [], // Pr√°zdn√Ω ≈ô√°dek
            ['Datum', 'Den v t√Ωdnu', 'Z√≠skan√© eKƒç za den', 'eKƒç celkem', 'P≈Øvodn√≠ pl√°n', 'Kritick√° mez', 'Upraven√Ω pl√°n (pozn√°mka)'],
          ]

          chartData.forEach((day, index) => {
            const adjustedCell = document.getElementById(`adjusted-plan-${index}`)
            const adjustedPlanText = adjustedCell.textContent.replace(/\n/g, ' ')

            wsData.push([
              day.date.toLocaleDateString('cs-CZ'),
              day.date.toLocaleDateString('cs-CZ', { weekday: 'long' }),
              day.dailyInput || 0,
              day.reality,
              day.plan,
              day.critical,
              adjustedPlanText,
            ])
          })

          // Vytvo≈ôen√≠ workbooku
          const wb = XLSX.utils.book_new()
          const ws = XLSX.utils.aoa_to_sheet(wsData)

          // Nastaven√≠ ≈°√≠≈ôky sloupc≈Ø
          ws['!cols'] = [
            { width: 12 }, // Datum
            { width: 12 }, // Den
            { width: 18 }, // Z√≠skan√© eKƒç
            { width: 16 }, // Celkem
            { width: 16 }, // Pl√°n
            { width: 16 }, // Kritick√°
            { width: 30 }, // Upraven√Ω pl√°n
          ]

          XLSX.utils.book_append_sheet(wb, ws, 'Data')

          // Vytvo≈ôen√≠ druh√©ho listu s daty pro graf
          const chartSheetData = [['Graf dat - Sledov√°n√≠ eKorun'], [], ['Datum', 'Realita', 'Pl√°n', 'Kritick√° mez']]

          chartData.forEach(day => {
            chartSheetData.push([day.date.toLocaleDateString('cs-CZ'), day.reality, day.plan, day.critical])
          })

          const chartWs = XLSX.utils.aoa_to_sheet(chartSheetData)
          chartWs['!cols'] = [{ width: 12 }, { width: 15 }, { width: 15 }, { width: 15 }]

          XLSX.utils.book_append_sheet(wb, chartWs, 'Graf')

          // Sta≈æen√≠ souboru
          const fileName = `eKoruny_tracker_${new Date().toISOString().split('T')[0]}.xlsx`
          XLSX.writeFile(wb, fileName)
        }

        // CSV Import funkce
        function importCSV(file) {
          const reader = new FileReader()
          reader.onload = function (e) {
            try {
              const csv = e.target.result
              const lines = csv.split('\n')

              if (lines.length < 2) {
                alert('CSV soubor je pr√°zdn√Ω nebo m√° nespr√°vn√Ω form√°t.')
                return
              }

              // P≈ôedpokl√°d√°me form√°t: Datum, Den, Z√≠skan√© eKƒç, eKƒç celkem, Pl√°n, Kritick√°, Upraven√Ω
              const dataLines = lines.slice(1) // P≈ôeskoƒçit hlaviƒçku
              let importCount = 0

              dataLines.forEach(line => {
                if (line.trim()) {
                  const columns = line.split(',')
                  if (columns.length >= 3) {
                    const dateStr = columns[0].trim()
                    const dailyAmount = parseFloat(columns[2]) || 0

                    // Naj√≠t odpov√≠daj√≠c√≠ den v na≈°ich datech
                    const matchingDay = chartData.find(day => {
                      const csvDate = new Date(dateStr.split('.').reverse().join('-')) // P≈ôevod z DD.MM.YYYY
                      return isSameDay(day.date, csvDate)
                    })

                    if (matchingDay && dailyAmount > 0) {
                      matchingDay.dailyInput = dailyAmount
                      importCount++
                    }
                  }
                }
              })

              if (importCount > 0) {
                // Aktualizovat tabulku
                chartData.forEach((day, index) => {
                  const input = document.querySelector(`input[data-index='${index}']`)
                  if (day.dailyInput > 0) {
                    input.value = day.dailyInput
                  } else {
                    input.value = ''
                  }
                })

                updateAll()
                saveDataToLocalStorage()
                alert(`√öspƒõ≈°nƒõ importov√°no ${importCount} z√°znam≈Ø!`)
              } else {
                alert('Nebyly nalezeny ≈æ√°dn√© platn√© z√°znamy k importu.')
              }
            } catch (error) {
              console.error('Chyba p≈ôi importu:', error)
              alert('Nastala chyba p≈ôi importu CSV souboru. Zkontrolujte form√°t souboru.')
            }
          }

          reader.readAsText(file, 'UTF-8')
        }

        // Event listenery
        tableBody.addEventListener('input', event => {
          if (event.target.tagName === 'INPUT') {
            const index = parseInt(event.target.dataset.index)
            chartData[index].dailyInput = parseFloat(event.target.value) || 0
            updateAll()
            saveDataToLocalStorage()
          }
        })

        document.getElementById('importCsvButton').addEventListener('click', () => {
          document.getElementById('csvFileInput').click()
        })

        document.getElementById('csvFileInput').addEventListener('change', event => {
          const file = event.target.files[0]
          if (file && file.type === 'text/csv') {
            if (confirm('Import CSV p≈ôep√≠≈°e existuj√≠c√≠ data. Chcete pokraƒçovat?')) {
              importCSV(file)
            }
          } else {
            alert('Pros√≠m vyberte platn√Ω CSV soubor.')
          }
          // Reset input pro mo≈ænost nahr√°t stejn√Ω soubor znovu
          event.target.value = ''
        })

        document.getElementById('downloadCsvButton').addEventListener('click', downloadCSV)

        document.getElementById('downloadExcelButton').addEventListener('click', downloadExcel)

        document.getElementById('clearDataButton').addEventListener('click', () => {
          if (confirm('Opravdu si p≈ôejete smazat v≈°echna zadan√° data? Tato akce je nevratn√°.')) {
            localStorage.removeItem(LOCAL_STORAGE_KEY)
            location.reload()
          }
        })

        // Prvn√≠ aktualizace
        updateAll()
      })
    </script>
  </body>
</html>
